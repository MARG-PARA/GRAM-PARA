import { __awaiter } from "tslib";
import { BaseLoginProvider } from '../entities/base-login-provider';
import { SocialUser } from '../entities/social-user';
/**
 * Protocol modes supported by MSAL.
 */
export var ProtocolMode;
(function (ProtocolMode) {
    ProtocolMode["AAD"] = "AAD";
    ProtocolMode["OIDC"] = "OIDC";
})(ProtocolMode || (ProtocolMode = {}));
const COMMON_AUTHORITY = 'https://login.microsoftonline.com/common/';
/**
 * Microsoft Authentication using MSAL v2: https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-browser
 */
export class MicrosoftLoginProvider extends BaseLoginProvider {
    constructor(clientId, initOptions) {
        super();
        this.clientId = clientId;
        this.initOptions = {
            authority: COMMON_AUTHORITY,
            scopes: ['openid', 'email', 'profile', 'User.Read'],
            knownAuthorities: [],
            protocolMode: ProtocolMode.AAD,
            clientCapabilities: [],
            cacheLocation: 'sessionStorage'
        };
        this.initOptions = Object.assign(Object.assign({}, this.initOptions), initOptions);
    }
    initialize() {
        return new Promise((resolve, reject) => {
            this.loadScript(MicrosoftLoginProvider.PROVIDER_ID, 'https://alcdn.msauth.net/browser/2.1.0/js/msal-browser.js', () => {
                var _a;
                try {
                    const config = {
                        auth: {
                            clientId: this.clientId,
                            redirectUri: (_a = this.initOptions.redirect_uri) !== null && _a !== void 0 ? _a : location.origin,
                            authority: this.initOptions.authority,
                            knownAuthorities: this.initOptions.knownAuthorities,
                            protocolMode: this.initOptions.protocolMode,
                            clientCapabilities: this.initOptions.clientCapabilities
                        },
                        cache: !this.initOptions.cacheLocation ? null : {
                            cacheLocation: this.initOptions.cacheLocation
                        }
                    };
                    this._instance = new msal.PublicClientApplication(config);
                    resolve();
                }
                catch (e) {
                    reject(e);
                }
            });
        });
    }
    getSocialUser(loginResponse) {
        return new Promise((resolve, reject) => {
            //After login, use Microsoft Graph API to get user info
            let meRequest = new XMLHttpRequest();
            meRequest.onreadystatechange = () => {
                if (meRequest.readyState == 4) {
                    try {
                        if (meRequest.status == 200) {
                            let userInfo = JSON.parse(meRequest.responseText);
                            let user = new SocialUser();
                            user.provider = MicrosoftLoginProvider.PROVIDER_ID;
                            user.id = loginResponse.idToken;
                            user.authToken = loginResponse.accessToken;
                            user.name = loginResponse.idTokenClaims.name;
                            user.email = loginResponse.account.username;
                            user.idToken = loginResponse.idToken;
                            user.response = loginResponse;
                            user.firstName = userInfo.givenName;
                            user.lastName = userInfo.surname;
                            resolve(user);
                        }
                        else {
                            reject(`Error retrieving user info: ${meRequest.status}`);
                        }
                    }
                    catch (err) {
                        reject(err);
                    }
                }
            };
            //Microsoft Graph ME Endpoint: https://docs.microsoft.com/en-us/graph/api/user-get?view=graph-rest-1.0&tabs=http
            meRequest.open('GET', 'https://graph.microsoft.com/v1.0/me');
            meRequest.setRequestHeader('Authorization', `Bearer ${loginResponse.accessToken}`);
            try {
                meRequest.send();
            }
            catch (err) {
                reject(err);
            }
        });
    }
    getLoginStatus() {
        return __awaiter(this, void 0, void 0, function* () {
            const accounts = this._instance.getAllAccounts();
            if ((accounts === null || accounts === void 0 ? void 0 : accounts.length) > 0) {
                const loginResponse = yield this._instance.ssoSilent({
                    scopes: this.initOptions.scopes,
                    loginHint: accounts[0].username
                });
                return yield this.getSocialUser(loginResponse);
            }
            else {
                throw `No user is currently logged in with ${MicrosoftLoginProvider.PROVIDER_ID}`;
            }
        });
    }
    signIn() {
        return __awaiter(this, void 0, void 0, function* () {
            const loginResponse = yield this._instance.loginPopup({
                scopes: this.initOptions.scopes
            });
            return yield this.getSocialUser(loginResponse);
        });
    }
    signOut(revoke) {
        var _a, _b;
        return __awaiter(this, void 0, void 0, function* () {
            const accounts = this._instance.getAllAccounts();
            if ((accounts === null || accounts === void 0 ? void 0 : accounts.length) > 0) {
                //TODO: This redirects to a Microsoft page, then sends us back to redirect_uri... this doesn't seem to match other providers
                //Open issues:
                // https://github.com/abacritt/angularx-social-login/issues/306
                // https://github.com/AzureAD/microsoft-authentication-library-for-js/issues/2563
                yield this._instance.logout({
                    account: accounts[0],
                    postLogoutRedirectUri: (_b = (_a = this.initOptions.logout_redirect_uri) !== null && _a !== void 0 ? _a : this.initOptions.redirect_uri) !== null && _b !== void 0 ? _b : location.href
                });
            }
        });
    }
}
MicrosoftLoginProvider.PROVIDER_ID = 'MICROSOFT';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWljcm9zb2Z0LWxvZ2luLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL0pBRFVUVEEvZGV2L3dlYi9hbmd1bGFyeC1zb2NpYWwtbG9naW4vcHJvamVjdHMvbGliL3NyYy8iLCJzb3VyY2VzIjpbInByb3ZpZGVycy9taWNyb3NvZnQtbG9naW4tcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVyRDs7R0FFRztBQUNILE1BQU0sQ0FBTixJQUFZLFlBR1g7QUFIRCxXQUFZLFlBQVk7SUFDdEIsMkJBQVcsQ0FBQTtJQUNYLDZCQUFhLENBQUE7QUFDZixDQUFDLEVBSFcsWUFBWSxLQUFaLFlBQVksUUFHdkI7QUFnRkQsTUFBTSxnQkFBZ0IsR0FBVywyQ0FBMkMsQ0FBQztBQUU3RTs7R0FFRztBQUNILE1BQU0sT0FBTyxzQkFBdUIsU0FBUSxpQkFBaUI7SUFhM0QsWUFDVSxRQUFnQixFQUN4QixXQUE4QjtRQUU5QixLQUFLLEVBQUUsQ0FBQztRQUhBLGFBQVEsR0FBUixRQUFRLENBQVE7UUFWbEIsZ0JBQVcsR0FBcUI7WUFDdEMsU0FBUyxFQUFFLGdCQUFnQjtZQUMzQixNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLENBQUM7WUFDbkQsZ0JBQWdCLEVBQUUsRUFBRTtZQUNwQixZQUFZLEVBQUUsWUFBWSxDQUFDLEdBQUc7WUFDOUIsa0JBQWtCLEVBQUUsRUFBRTtZQUN0QixhQUFhLEVBQUUsZ0JBQWdCO1NBQ2hDLENBQUM7UUFRQSxJQUFJLENBQUMsV0FBVyxtQ0FDWCxJQUFJLENBQUMsV0FBVyxHQUNoQixXQUFXLENBQ2YsQ0FBQztJQUNKLENBQUM7SUFFRCxVQUFVO1FBQ1IsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8s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QyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDakQsSUFBSSxDQUFBLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxNQUFNLElBQUcsQ0FBQyxFQUFFO2dCQUN4Qiw0SEFBNEg7Z0JBQzVILGNBQWM7Z0JBQ2QsK0RBQStEO2dCQUMvRCxpRkFBaUY7Z0JBQ2pGLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7b0JBQzFCLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO29CQUNwQixxQkFBcUIsY0FBRSxJQUFJLENBQUMsV0FBVyxDQUFDLG1CQUFtQixtQ0FBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksbUNBQUksUUFBUSxDQUFDLElBQUk7aUJBQzlHLENBQUMsQ0FBQTthQUNIOztLQUNGOztBQWhJc0Isa0NBQVcsR0FBVyxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlTG9naW5Qcm92aWRlciB9IGZyb20gJy4uL2VudGl0aWVzL2Jhc2UtbG9naW4tcHJvdmlkZXInO1xyXG5pbXBvcnQgeyBTb2NpYWxVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvc29jaWFsLXVzZXInO1xyXG5cclxuLyoqXHJcbiAqIFByb3RvY29sIG1vZGVzIHN1cHBvcnRlZCBieSBNU0FMLlxyXG4gKi9cclxuZXhwb3J0IGVudW0gUHJvdG9jb2xNb2RlIHtcclxuICBBQUQgPSAnQUFEJyxcclxuICBPSURDID0gJ09JREMnXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbml0aWFsaXphdGlvbiBPcHRpb25zIGZvciBNaWNyb3NvZnQgUHJvdmlkZXI6IGh0dHBzOi8vZ2l0aHViLmNvbS9BenVyZUFEL21pY3Jvc29mdC1hdXRoZW50aWNhdGlvbi1saWJyYXJ5LWZvci1qcy9ibG9iL2Rldi9saWIvbXNhbC1icm93c2VyL2RvY3MvaW5pdGlhbGl6YXRpb24ubWRcclxuICogRGV0YWlscyAobm90IGFsbCBvcHRpb25zIGFyZSBzdXBwb3J0ZWQpOiBodHRwczovL2dpdGh1Yi5jb20vQXp1cmVBRC9taWNyb3NvZnQtYXV0aGVudGljYXRpb24tbGlicmFyeS1mb3ItanMvYmxvYi9kZXYvbGliL21zYWwtYnJvd3Nlci9kb2NzL2NvbmZpZ3VyYXRpb24ubWRcclxuICovXHJcbmV4cG9ydCB0eXBlIE1pY3Jvc29mdE9wdGlvbnMgPSB7XHJcbiAgcmVkaXJlY3RfdXJpPzogc3RyaW5nLFxyXG4gIGxvZ291dF9yZWRpcmVjdF91cmk/OiBzdHJpbmcsXHJcbiAgYXV0aG9yaXR5Pzogc3RyaW5nLFxyXG4gIGtub3duQXV0aG9yaXRpZXM/OiBzdHJpbmdbXSxcclxuICBwcm90b2NvbE1vZGU/OiBQcm90b2NvbE1vZGUsXHJcbiAgY2xpZW50Q2FwYWJpbGl0aWVzPzogc3RyaW5nW10sXHJcbiAgY2FjaGVMb2NhdGlvbj86IHN0cmluZyxcclxuICBzY29wZXM/OiBzdHJpbmdbXVxyXG59O1xyXG5cclxuLy8gQ29sbGVjdGlvbiBvZiBpbnRlcm5hbCBNU0FMIGludGVyZmFjZXMgZnJvbTogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL3RyZWUvZGV2L2xpYi9tc2FsLWJyb3dzZXIvc3JjXHJcblxyXG5pbnRlcmZhY2UgTVNBTEFjY291bnQge1xyXG4gIGVudmlyb25tZW50OiBzdHJpbmc7XHJcbiAgaG9tZUFjY291bnRJZDogc3RyaW5nO1xyXG4gIHRlbmFudElkOiBzdHJpbmc7XHJcbiAgdXNlcm5hbWU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIE1TR3JhcGhVc2VySW5mbyB7XHJcbiAgYnVzaW5lc3NQaG9uZXM6IHN0cmluZ1tdO1xyXG4gIGRpc3BsYXlOYW1lOiBzdHJpbmc7XHJcbiAgZ2l2ZW5OYW1lOiBzdHJpbmc7XHJcbiAgaWQ6IHN0cmluZztcclxuICBqb2JUaXRsZTogc3RyaW5nO1xyXG4gIG1haWw6IHN0cmluZztcclxuICBtb2JpbGVQaG9uZTogc3RyaW5nO1xyXG4gIG9mZmljZUxvY2F0aW9uOiBzdHJpbmc7XHJcbiAgcHJlZmVycmVkTGFuZ3VhZ2U6IHN0cmluZztcclxuICBzdXJuYW1lOiBzdHJpbmc7XHJcbiAgdXNlclByaW5jaXBhbE5hbWU6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIE1TQUxMb2dpblJlcXVlc3Qge1xyXG4gIHNjb3Blcz86IHN0cmluZ1tdO1xyXG4gIHNpZD86IHN0cmluZztcclxuICBsb2dpbkhpbnQ/OiBzdHJpbmc7XHJcbiAgZG9tYWluSGludD86IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIE1TQUxMb2dpblJlc3BvbnNlIHtcclxuICBhY2Nlc3NUb2tlbjogc3RyaW5nO1xyXG4gIGFjY291bnQ6IE1TQUxBY2NvdW50O1xyXG4gIGV4cGlyZXNPbjogRGF0ZTtcclxuICBleHRFeHBpcmVzT246IERhdGU7XHJcbiAgZmFtaWx5SWQ6IHN0cmluZztcclxuICBmcm9tQ2FjaGU6IGJvb2xlYW47XHJcbiAgaWRUb2tlbjogc3RyaW5nO1xyXG4gIGlkVG9rZW5DbGFpbXM6IGFueTtcclxuICBzY29wZXM6IHN0cmluZ1tdO1xyXG4gIHN0YXRlOiBzdHJpbmc7XHJcbiAgdGVuYW50SWQ6IHN0cmluZztcclxuICB1bmlxdWVJZDogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgTVNBTExvZ291dFJlcXVlc3Qge1xyXG4gIGFjY291bnQ/OiBNU0FMQWNjb3VudDtcclxuICBwb3N0TG9nb3V0UmVkaXJlY3RVcmk/OiBzdHJpbmc7XHJcbiAgYXV0aG9yaXR5Pzogc3RyaW5nO1xyXG4gIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBNU0FMQ2xpZW50QXBwbGljYXRpb24ge1xyXG4gIGdldEFsbEFjY291bnRzKCk6IE1TQUxBY2NvdW50W107XHJcbiAgbG9nb3V0KGxvZ291dFJlcXVlc3Q/OiBNU0FMTG9nb3V0UmVxdWVzdCk6IFByb21pc2U8dm9pZD47XHJcbiAgbG9naW5Qb3B1cChsb2dpblJlcXVlc3Q6IE1TQUxMb2dpblJlcXVlc3QpOiBQcm9taXNlPE1TQUxMb2dpblJlc3BvbnNlPjtcclxuICBzc29TaWxlbnQobG9naW5SZXF1ZXN0OiBNU0FMTG9naW5SZXF1ZXN0KTogUHJvbWlzZTxNU0FMTG9naW5SZXNwb25zZT47XHJcbiAgYWNxdWlyZVRva2VuU2lsZW50KGxvZ2luUmVxdWVzdDogTVNBTExvZ2luUmVxdWVzdCk6IFByb21pc2U8TVNBTExvZ2luUmVzcG9uc2U+O1xyXG4gIGdldEFjY291bnRCeUhvbWVJZChob21lQWNjb3VudElkOiBzdHJpbmcpOiBNU0FMQWNjb3VudDtcclxufVxyXG5cclxuZGVjbGFyZSBsZXQgbXNhbDogYW55O1xyXG5cclxuY29uc3QgQ09NTU9OX0FVVEhPUklUWTogc3RyaW5nID0gJ2h0dHBzOi8vbG9naW4ubWljcm9zb2Z0b25saW5lLmNvbS9jb21tb24vJztcclxuXHJcbi8qKlxyXG4gKiBNaWNyb3NvZnQgQXV0aGVudGljYXRpb24gdXNpbmcgTVNBTCB2MjogaHR0cHM6Ly9naXRodWIuY29tL0F6dXJlQUQvbWljcm9zb2Z0LWF1dGhlbnRpY2F0aW9uLWxpYnJhcnktZm9yLWpzL3RyZWUvZGV2L2xpYi9tc2FsLWJyb3dzZXJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBNaWNyb3NvZnRMb2dpblByb3ZpZGVyIGV4dGVuZHMgQmFzZUxvZ2luUHJvdmlkZXIge1xyXG4gIHByaXZhdGUgX2luc3RhbmNlOiBNU0FMQ2xpZW50QXBwbGljYXRpb247XHJcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBQUk9WSURFUl9JRDogc3RyaW5nID0gJ01JQ1JPU09GVCc7XHJcblxyXG4gIHByaXZhdGUgaW5pdE9wdGlvbnM6IE1pY3Jvc29mdE9wdGlvbnMgPSB7XHJcbiAgICBhdXRob3JpdHk6IENPTU1PTl9BVVRIT1JJVFksXHJcbiAgICBzY29wZXM6IFsnb3BlbmlkJywgJ2VtYWlsJywgJ3Byb2ZpbGUnLCAnVXNlci5SZWFkJ10sXHJcbiAgICBrbm93bkF1dGhvcml0aWVzOiBbXSxcclxuICAgIHByb3RvY29sTW9kZTogUHJvdG9jb2xNb2RlLkFBRCxcclxuICAgIGNsaWVudENhcGFiaWxpdGllczogW10sXHJcbiAgICBjYWNoZUxvY2F0aW9uOiAnc2Vzc2lvblN0b3JhZ2UnXHJcbiAgfTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNsaWVudElkOiBzdHJpbmcsXHJcbiAgICBpbml0T3B0aW9ucz86IE1pY3Jvc29mdE9wdGlvbnNcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5pbml0T3B0aW9ucyA9IHtcclxuICAgICAgLi4udGhpcy5pbml0T3B0aW9ucyxcclxuICAgICAgLi4uaW5pdE9wdGlvbnNcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBpbml0aWFsaXplKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5sb2FkU2NyaXB0KFxyXG4gICAgICAgIE1pY3Jvc29mdExvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQsXHJcbiAgICAgICAgJ2h0dHBzOi8vYWxjZG4ubXNhdXRoLm5ldC9icm93c2VyLzIuMS4wL2pzL21zYWwtYnJvd3Nlci5qcycsXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnID0ge1xyXG4gICAgICAgICAgICAgIGF1dGg6IHtcclxuICAgICAgICAgICAgICAgIGNsaWVudElkOiB0aGlzLmNsaWVudElkLFxyXG4gICAgICAgICAgICAgICAgcmVkaXJlY3RVcmk6IHRoaXMuaW5pdE9wdGlvbnMucmVkaXJlY3RfdXJpID8/IGxvY2F0aW9uLm9yaWdpbixcclxuICAgICAgICAgICAgICAgIGF1dGhvcml0eTogdGhpcy5pbml0T3B0aW9ucy5hdXRob3JpdHksXHJcbiAgICAgICAgICAgICAgICBrbm93bkF1dGhvcml0aWVzOiB0aGlzLmluaXRPcHRpb25zLmtub3duQXV0aG9yaXRpZXMsXHJcbiAgICAgICAgICAgICAgICBwcm90b2NvbE1vZGU6IHRoaXMuaW5pdE9wdGlvbnMucHJvdG9jb2xNb2RlLFxyXG4gICAgICAgICAgICAgICAgY2xpZW50Q2FwYWJpbGl0aWVzOiB0aGlzLmluaXRPcHRpb25zLmNsaWVudENhcGFiaWxpdGllc1xyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgY2FjaGU6ICF0aGlzLmluaXRPcHRpb25zLmNhY2hlTG9jYXRpb24gPyBudWxsIDoge1xyXG4gICAgICAgICAgICAgICAgY2FjaGVMb2NhdGlvbjogdGhpcy5pbml0T3B0aW9ucy5jYWNoZUxvY2F0aW9uXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBuZXcgbXNhbC5QdWJsaWNDbGllbnRBcHBsaWNhdGlvbihjb25maWcpO1xyXG4gICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJlamVjdChlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0U29jaWFsVXNlcihsb2dpblJlc3BvbnNlKTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8U29jaWFsVXNlcj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAvL0FmdGVyIGxvZ2luLCB1c2UgTWljcm9zb2Z0IEdyYXBoIEFQSSB0byBnZXQgdXNlciBpbmZvXHJcbiAgICAgIGxldCBtZVJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgICAgbWVSZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICgpID0+IHtcclxuICAgICAgICBpZiAobWVSZXF1ZXN0LnJlYWR5U3RhdGUgPT0gNCkge1xyXG4gICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKG1lUmVxdWVzdC5zdGF0dXMgPT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgbGV0IHVzZXJJbmZvID0gPE1TR3JhcGhVc2VySW5mbz5KU09OLnBhcnNlKG1lUmVxdWVzdC5yZXNwb25zZVRleHQpO1xyXG5cclxuICAgICAgICAgICAgICBsZXQgdXNlcjogU29jaWFsVXNlciA9IG5ldyBTb2NpYWxVc2VyKCk7XHJcbiAgICAgICAgICAgICAgdXNlci5wcm92aWRlciA9IE1pY3Jvc29mdExvZ2luUHJvdmlkZXIuUFJPVklERVJfSUQ7XHJcbiAgICAgICAgICAgICAgdXNlci5pZCA9IGxvZ2luUmVzcG9uc2UuaWRUb2tlbjtcclxuICAgICAgICAgICAgICB1c2VyLmF1dGhUb2tlbiA9IGxvZ2luUmVzcG9uc2UuYWNjZXNzVG9rZW47XHJcbiAgICAgICAgICAgICAgdXNlci5uYW1lID0gbG9naW5SZXNwb25zZS5pZFRva2VuQ2xhaW1zLm5hbWU7XHJcbiAgICAgICAgICAgICAgdXNlci5lbWFpbCA9IGxvZ2luUmVzcG9uc2UuYWNjb3VudC51c2VybmFtZTtcclxuICAgICAgICAgICAgICB1c2VyLmlkVG9rZW4gPSBsb2dpblJlc3BvbnNlLmlkVG9rZW47XHJcbiAgICAgICAgICAgICAgdXNlci5yZXNwb25zZSA9IGxvZ2luUmVzcG9uc2U7XHJcbiAgICAgICAgICAgICAgdXNlci5maXJzdE5hbWUgPSB1c2VySW5mby5naXZlbk5hbWU7XHJcbiAgICAgICAgICAgICAgdXNlci5sYXN0TmFtZSA9IHVzZXJJbmZvLnN1cm5hbWU7XHJcblxyXG4gICAgICAgICAgICAgIHJlc29sdmUodXNlcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KGBFcnJvciByZXRyaWV2aW5nIHVzZXIgaW5mbzogJHttZVJlcXVlc3Quc3RhdHVzfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgLy9NaWNyb3NvZnQgR3JhcGggTUUgRW5kcG9pbnQ6IGh0dHBzOi8vZG9jcy5taWNyb3NvZnQuY29tL2VuLXVzL2dyYXBoL2FwaS91c2VyLWdldD92aWV3PWdyYXBoLXJlc3QtMS4wJnRhYnM9aHR0cFxyXG4gICAgICBtZVJlcXVlc3Qub3BlbignR0VUJywgJ2h0dHBzOi8vZ3JhcGgubWljcm9zb2Z0LmNvbS92MS4wL21lJyk7XHJcbiAgICAgIG1lUmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCdBdXRob3JpemF0aW9uJywgYEJlYXJlciAke2xvZ2luUmVzcG9uc2UuYWNjZXNzVG9rZW59YCk7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgbWVSZXF1ZXN0LnNlbmQoKTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0TG9naW5TdGF0dXMoKTogUHJvbWlzZTxTb2NpYWxVc2VyPiB7XHJcbiAgICBjb25zdCBhY2NvdW50cyA9IHRoaXMuX2luc3RhbmNlLmdldEFsbEFjY291bnRzKCk7XHJcbiAgICBpZiAoYWNjb3VudHM/Lmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHRoaXMuX2luc3RhbmNlLnNzb1NpbGVudCh7XHJcbiAgICAgICAgc2NvcGVzOiB0aGlzLmluaXRPcHRpb25zLnNjb3BlcyxcclxuICAgICAgICBsb2dpbkhpbnQ6IGFjY291bnRzWzBdLnVzZXJuYW1lXHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTb2NpYWxVc2VyKGxvZ2luUmVzcG9uc2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgYE5vIHVzZXIgaXMgY3VycmVudGx5IGxvZ2dlZCBpbiB3aXRoICR7TWljcm9zb2Z0TG9naW5Qcm92aWRlci5QUk9WSURFUl9JRH1gO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2lnbkluKCk6IFByb21pc2U8U29jaWFsVXNlcj4ge1xyXG4gICAgY29uc3QgbG9naW5SZXNwb25zZSA9IGF3YWl0IHRoaXMuX2luc3RhbmNlLmxvZ2luUG9wdXAoe1xyXG4gICAgICBzY29wZXM6IHRoaXMuaW5pdE9wdGlvbnMuc2NvcGVzXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFNvY2lhbFVzZXIobG9naW5SZXNwb25zZSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBzaWduT3V0KHJldm9rZT86IGJvb2xlYW4pOiBQcm9taXNlPGFueT4ge1xyXG4gICAgY29uc3QgYWNjb3VudHMgPSB0aGlzLl9pbnN0YW5jZS5nZXRBbGxBY2NvdW50cygpO1xyXG4gICAgaWYgKGFjY291bnRzPy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vVE9ETzogVGhpcyByZWRpcmVjdHMgdG8gYSBNaWNyb3NvZnQgcGFnZSwgdGhlbiBzZW5kcyB1cyBiYWNrIHRvIHJlZGlyZWN0X3VyaS4uLiB0aGlzIGRvZXNuJ3Qgc2VlbSB0byBtYXRjaCBvdGhlciBwcm92aWRlcnNcclxuICAgICAgLy9PcGVuIGlzc3VlczpcclxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FiYWNyaXR0L2FuZ3VsYXJ4LXNvY2lhbC1sb2dpbi9pc3N1ZXMvMzA2XHJcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9BenVyZUFEL21pY3Jvc29mdC1hdXRoZW50aWNhdGlvbi1saWJyYXJ5LWZvci1qcy9pc3N1ZXMvMjU2M1xyXG4gICAgICBhd2FpdCB0aGlzLl9pbnN0YW5jZS5sb2dvdXQoe1xyXG4gICAgICAgIGFjY291bnQ6IGFjY291bnRzWzBdLFxyXG4gICAgICAgIHBvc3RMb2dvdXRSZWRpcmVjdFVyaTogdGhpcy5pbml0T3B0aW9ucy5sb2dvdXRfcmVkaXJlY3RfdXJpID8/IHRoaXMuaW5pdE9wdGlvbnMucmVkaXJlY3RfdXJpID8/IGxvY2F0aW9uLmhyZWZcclxuICAgICAgfSlcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19